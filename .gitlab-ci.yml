stages:
  - conda-package-build
  - conda-package-deploy

.wget_common: &wget-common
  - echo -e "\e[0Ksection_start:$(date +%s):wget_common[collapsed=true]\r\e[0Kwget common.sh - $(date)"
  - wget -O tmp.sh https://gitlab.rennes.ariadnext.com/ocr-docker-utils/common-tools/raw/master/common.sh && source tmp.sh && rm tmp.sh
  - echo -e "\e[0Ksection_end:$(date +%s):wget_common\r\e[0K"


conda-package-build:
  stage: conda-package-build
  script:
    - echo "Conda Package Build"
    - if [ "$(docker ps -aq -f name=temporary_container)" ]; then docker rm -f temporary_container; fi
    - USERNAME=$(whoami) 
    - docker build --build-arg USERNAME=${USERNAME} --build-arg irma_rsa="$IRMA_RSA" --build-arg irma_rsa_pub="$IRMA_RSA_PUB" --build-arg known_hosts="$KNOWN_HOSTS" -t autordf_conda_packaging -f ./docker/Dockerfile.buildconda .
    - docker run -v ./:/workspaces --name temporary_container autordf_conda_packaging:latest bash -c "cd /workspaces && conda build recipe"
    - docker cp temporary_container:/home/$USERNAME/conda-bld/linux-64/*.tar.bz2 ./
    - docker rm temporary_container
  artifacts:
    expire_in: 2 hour
    paths:
      - ./*.tar.bz2
  tags:
  - ocr
  - docker
  - shell


conda-package-deploy:
  stage: conda-package-deploy
  variables:
    CHANNEL: falcon
  script:
    - echo "Conda Package Deploy"
    - echo "Channel Conda ${CHANNEL}"
  tags:
    - ocr
    - docker
    - shell
  needs:
    - job: conda-package-build
      artifacts: true

