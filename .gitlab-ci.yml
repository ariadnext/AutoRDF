stages:
  - setup-builder
  - conda-build
  - deploy

.wget_common: &wget-common
  - echo -e "\e[0Ksection_start:$(date +%s):wget_common[collapsed=true]\r\e[0Kwget common.sh - $(date)"
  - wget -O tmp.sh https://gitlab.rennes.ariadnext.com/ocr-docker-utils/common-tools/raw/master/common.sh && source tmp.sh && rm tmp.sh
  - echo -e "\e[0Ksection_end:$(date +%s):wget_common\r\e[0K"


setup-builder:
  stage: setup-builder
  script:
    - docker rm temporary_container
    - echo $IRMA_RSA
    - echo $IRMA_RSA_PUB
    - echo $KNOWN_HOSTS
    - docker build --build-arg irma_rsa="$IRMA_RSA" --build-arg irma_rsa_pub="$IRMA_RSA_PUB" --build-arg known_hosts="$KNOWN_HOSTS" -t autordf_conda_packaging -f ./docker/Dockerfile.buildconda .
    - docker run -v ./:/workspaces:ro --name temporary_container autordf_conda_packaging:latest bash -c "cd /workspaces && conda build recipe"
    - docker cp temporary_container:/home/developer/conda-bld/linux-64/*.tar.bz2 ./
    - docker rm temporary_container
  artifacts:
    expire_in: 2 hour
    paths:
      - ./*.tar.bz2

  tags:
  - ocr
  - docker
  - shell


conda-build:
  stage: conda-build
  script:
    - echo "Conda Build Recipe"
  tags:
    - ocr
    - docker
    - shell

deploy:
  stage: deploy
  script:
    - echo "Deploy"
  tags:
    - ocr
    - docker
    - shell
